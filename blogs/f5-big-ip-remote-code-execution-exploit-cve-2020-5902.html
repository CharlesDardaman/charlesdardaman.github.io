<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>F5 BIG-IP Remote Code Execution Exploit – CVE-2020-5902</title>
    <meta name="description" content="Breaking down how CyberOne researchers bypassed TMUI authentication and achieved remote code execution against vulnerable F5 BIG-IP appliances." />
    <link rel="stylesheet" href="../assets/css/blog.css" />
  </head>
  <body>
    <header class="masthead">
      <div class="masthead__inner">
        <div class="brand">
          <a class="brand__link" href="../index.html">Charles Dardaman</a>
          <p class="brand__tagline">Security engineering, incident response, research.</p>
        </div>
        <nav class="site-nav" aria-label="Primary">
          <ul>
            <li><a href="../index.html#about">About</a></li>
            <li><a href="../index.html#writing">Writing</a></li>
            <li><a href="../index.html#connect">Connect</a></li>
          </ul>
        </nav>
      </div>
    </header>

    <header class="post-header">
      <h1>F5 BIG-IP Remote Code Execution Exploit – CVE-2020-5902</h1>
      <p><time datetime="2020-07-06">July 6, 2020</time></p>
    </header>

    <main>
      <article>
        <p><em>Originally published at <a href="https://www.cyberonesecurity.com/f5-big-ip-remote-code-execution-exploit-cve-2020-5902/" target="_blank" rel="noopener">https://www.cyberonesecurity.com/f5-big-ip-remote-code-execution-exploit-cve-2020-5902/</a>. An archived copy appears below.</em></p>

        <p>When CyberOne began research into the vulnerability identified in the F5 TMUI RCE vulnerability <a href="https://support.f5.com/csp/article/K52145254" target="_blank" rel="noopener">advisory</a>, we started by reading the advisory and mitigation steps. The write-up contained limited detail, but it still provided key breadcrumbs to kick off the investigation. One comment in particular stood out: successful exploitation could lead to arbitrary Java code execution.</p>

        <figure>
          <img src="../images/61dcfcebedd291607919943b_f1-1024x232.png" alt="Screenshot of the F5 advisory detailing the vulnerability impact" />
          <figcaption>Figure 1: Vulnerability impact statement</figcaption>
        </figure>

        <p>Reviewing the mitigation steps immediately suggested directory traversal and command injection. The pattern in the advisory included a key character — the semicolon.</p>

        <figure>
          <img src="../images/61dcfcea2a259d9afd473999_f2-2-1.png" alt="Screenshot of mitigation guidance highlighting a semicolon in the URI" />
          <figcaption>Figure 2: Mitigation guidance</figcaption>
        </figure>

        <p>The first step was to compare configurations between known vulnerable builds and patched releases. We diffed BIG-IP version 15.1.0 against 15.1.0.4 and found numerous changes. The Apache configuration updates shown below were especially interesting and pushed us further down the rabbit hole.</p>

        <p>The screenshots reveal that the <code>/hsqldb</code> endpoint was removed from the reverse proxy configuration, even though the Tomcat application server still listens on <code>localhost:8009</code>.</p>

        <figure>
          <img src="../images/61dcfceadced15afa0db819f_f3-1536x349-1-1024x233.png" alt="Diff output showing the hsqldb endpoint removed from proxy_ajp.conf" />
          <figcaption>Figure 3: Differences in <code>proxy_ajp.conf</code></figcaption>
        </figure>

        <figure>
          <img src="../images/61dcfceaf29296a178f588cf_f4-1024x668.png" alt="Diff output showing updated hsqldb rules in httpd.conf" />
          <figcaption>Figure 4: Differences in <code>httpd.conf</code></figcaption>
        </figure>

        <p>A basic unauthenticated <code>GET</code> request redirected us to the login page, which is expected because TMUI requires authentication.</p>

        <figure>
          <img src="../images/61dcfcea3f03cc298a41fd5a_f5-1024x240-1.png" alt="HTTP response showing a redirect to the login page" />
          <figcaption>Figure 5: HTTP redirect to login</figcaption>
        </figure>

        <p>Remembering the mitigation regex, we appended a semicolon. The request now reached the application server, effectively bypassing authentication. This endpoint should never have been reachable without credentials.</p>

        <figure>
          <img src="../images/61dcfcea3d2f9f565eb059a4_f6-1024x237-1.png" alt="HTTP response showing successful access to the hsqldb endpoint after adding a semicolon" />
          <figcaption>Figure 6: Authentication bypass</figcaption>
        </figure>

        <p>With access to <code>/hsqldb</code>, we explored how far the exposure could be pushed. <a href="https://hsqldb.org/" target="_blank" rel="noopener">HyperSQL</a> is an embedded relational database used by Java applications. Our goal was to understand whether it could be abused for remote code execution.</p>

        <p>The original plan involved a user-defined function, but version 1.8 of HyperSQL does not support UDFs. We pivoted to native Java functions, focusing on methods that were both static and accessible to the server. The <code>org.hsqldb.util.ScriptTool.main()</code> method deserializes Java objects that are represented as ASCII hex strings. That looked promising, so we attempted a manual invocation via <a href="https://hsqldb.org/doc/2.0/util-guide/sqltool-chapt.html" target="_blank" rel="noopener">sqltool</a>, only to hit a serialization failure.</p>

        <figure>
          <img src="../images/61dcfceafacf8a8447f7888b_f7.png" alt="Sqltool output showing a serialization failure when calling ScriptTool" />
          <figcaption>Figure 7: Serialization exception</figcaption>
        </figure>

        <p>The error message hinted at the fix. After setting the <code>enableUnsafeSerialization</code> property to <code>true</code>, the payload executed successfully. We now had proof that authenticated remote code execution was viable. Changing our exploit so the request path matched the mitigation regex (<code>..;</code>) provided direct access to HyperSQL without triggering the block, enabling unauthenticated execution.</p>

        <figure>
          <img src="../images/61dcfcebfd38e97ab9baa37e_f8-1024x448.png" alt="Terminal output demonstrating remote code execution via HyperSQL" />
          <figcaption>Figure 8: Remote code execution</figcaption>
        </figure>

        <p>From there we created a new TMUI user with the <code>admin</code> role through <code>tmsh</code>, which in turn provisioned a root system account — escalating privileges locally.</p>

        <figure>
          <img src="../images/61dcfceb4c6bdaced6ba615f_f9-1024x392.png" alt="tmsh command output showing a new admin user being created" />
          <figcaption>Figure 9: Local privilege escalation</figcaption>
        </figure>

        <p><strong>Versions Tested:</strong></p>
        <ul>
          <li>F5 BIG-IP 15.1.0</li>
          <li>F5 BIG-IP 14.0.0</li>
        </ul>

        <p><strong>References:</strong></p>
        <ul>
          <li><a href="https://support.f5.com/csp/article/K52145254" target="_blank" rel="noopener">https://support.f5.com/csp/article/K52145254</a></li>
          <li><a href="https://www.ptsecurity.com/ww-en/about/news/f5-fixes-critical-vulnerability-discovered-by-positive-technologies-in-big-ip-application-delivery-controller/" target="_blank" rel="noopener">https://www.ptsecurity.com/ww-en/about/news/f5-fixes-critical-vulnerability-discovered-by-positive-technologies-in-big-ip-application-delivery-controller/</a></li>
        </ul>

        <p><strong>Credit:</strong></p>
        <p>Authentication bypass discovered by Mikhail Klyuchnikov of Positive Technologies.</p>
        <p>Proof of concept research by Charles Dardaman and Rich Mirch at CyberOne.</p>
      </article>
      <div class="footer">
        <a href="../index.html">← Back to homepage</a>
      </div>
    </main>

    <footer class="site-footer">
      <p>&copy; <span id="current-year"></span> Charles Dardaman</p>
    </footer>

    <script>
      const year = new Date().getFullYear();
      document.getElementById("current-year").textContent = year;
    </script>
  </body>
</html>
